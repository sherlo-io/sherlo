name: 'Sherlo Testing'

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment (dev, test, prod)'
        required: true
        default: 'dev'
        type: string
      preview_builds:
        description: 'Builds: Preview'
        required: false
        default: false
        type: boolean
      development_builds:
        description: 'Builds: Development'
        required: false
        default: false
        type: boolean
      storybook_builds:
        description: 'Builds: Storybook'
        required: false
        default: false
        type: boolean
      device_testing:
        description: 'Test: All Devices'
        required: false
        default: false
        type: boolean
      stress_testing:
        description: 'Test: Stress Testing (20 builds)'
        required: false
        default: false
        type: boolean
      rn_local_builds:
        description: 'Test: local-builds (React Native)'
        required: false
        default: false
        type: boolean
      expo_local_builds:
        description: 'Test: local-builds (Expo)'
        required: false
        default: false
        type: boolean
      expo_cloud:
        description: 'Test: expo-cloud'
        required: false
        default: false
        type: boolean
      expo_update:
        description: 'Test: expo-update'
        required: false
        default: false
        type: boolean

jobs:
  update_preview_builds:
    uses: ./.github/workflows/update_builds.yml
    if: ${{ github.event.inputs.preview_builds == 'true'}}
    name: Update Preview Builds
    secrets: inherit
    with:
      profile: 'preview'

  update_development_builds:
    uses: ./.github/workflows/update_builds.yml
    if: ${{ github.event.inputs.development_builds == 'true'}}
    name: Update Development Builds
    secrets: inherit
    with:
      profile: 'development'

  update_storybook_builds:
    uses: ./.github/workflows/update_builds.yml
    if: ${{ github.event.inputs.storybook_builds == 'true'}}
    name: Update Storybook Builds
    secrets: inherit
    with:
      profile: 'storybook'

  device_testing:
    uses: ./.github/workflows/device_testing.yml
    needs: [update_preview_builds]
    if: ${{ github.event.inputs.device_testing == 'true' && always() && !failure() && !cancelled() }}
    name: Device Testing
    secrets: inherit
    with:
      env: ${{ github.event.inputs.env }}

  stress_testing:
    uses: ./.github/workflows/stress_testing.yml
    needs: [update_preview_builds]
    if: ${{ github.event.inputs.stress_testing == 'true' && always() && !failure() && !cancelled() }}
    name: Stress Testing
    secrets: inherit
    with:
      env: ${{ github.event.inputs.env }}

  rn_local_builds:
    uses: ./.github/workflows/rn_local-builds.yml
    needs: [update_preview_builds]
    if: ${{ github.event.inputs.rn_local_builds == 'true' && always() && !failure() && !cancelled() }}
    name: local-builds (React Native)
    secrets: inherit
    with:
      env: ${{ github.event.inputs.env }}

  expo_local_builds:
    uses: ./.github/workflows/expo_local-builds.yml
    needs: [update_storybook_builds]
    if: ${{ github.event.inputs.expo_local_builds == 'true' && always() && !failure() && !cancelled() }}
    name: local-builds (Expo)
    secrets: inherit
    with:
      env: ${{ github.event.inputs.env }}

  expo_cloud:
    uses: ./.github/workflows/expo-cloud.yml
    needs: [update_preview_builds]
    if: ${{ github.event.inputs.expo_cloud == 'true' && always() && !failure() && !cancelled() }}
    name: expo-cloud
    secrets: inherit
    with:
      env: ${{ github.event.inputs.env }}

  expo_update:
    uses: ./.github/workflows/expo-update.yml
    needs: [update_development_builds]
    if: ${{ github.event.inputs.expo_update == 'true' && always() && !failure() && !cancelled() }}
    name: expo-update
    secrets: inherit
    with:
      env: ${{ github.event.inputs.env }}
