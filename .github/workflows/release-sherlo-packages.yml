name: Release Sherlo Packages

on:
  workflow_dispatch:
    inputs:
      NEW_VERSION_NUMBER:
        description: 'New version number (e.g., 1.0.1)'
        required: false
      BUMP_REQUIRED_SDK_VERSION:
        description: 'SDK contains breaking changes'
        required: false
        default: false
        type: boolean
      IS_ALPHA:
        description: 'Is alpha release'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write # Required for OIDC trusted publishing
  contents: write # Required for commits and tagging

jobs:
  release-to-prod:
    runs-on: ubuntu-latest

    env:
      SLACK_WEBHOOK_URL: ${{secrets.SLACK_WEBHOOK_URL}}
      NEW_VERSION_NUMBER: ${{ github.event.inputs.NEW_VERSION_NUMBER }}
    concurrency: release-to-prod
    steps:
      - name: Create GH App Token
        id: github_app_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.SHERLO_BOT_APP_ID }}
          private_key: ${{ secrets.SHERLO_BOT_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.github_app_token.outputs.token }}
          ref: ${{ github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Check npm version
        run: npm --version

      - name: Add env specific dependencies
        run: ./scripts/switch-env.sh prod
        env:
          PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

      - name: Install dependencies
        run: yarn

      # TEMPORARILY COMMENTED OUT - Version 1.5.3 already committed
      # - name: Bump Version
      #   run: npx lerna version $NEW_VERSION_NUMBER --yes --no-git-tag-version --no-push

      # - name: Save version number to native dependencies
      #   run: |
      #     echo "{\"version\": \"$NEW_VERSION_NUMBER\"}" > packages/react-native-storybook/android/src/main/assets/sherlo.json
      #     echo "{\"version\": \"$NEW_VERSION_NUMBER\"}" > packages/react-native-storybook/ios/Resources/assets/sherlo.json

      # - name: Bump minimum required native dependencies version
      #   if: ${{ github.event.inputs.BUMP_REQUIRED_SDK_VERSION == 'true' }}
      #   run: |
      #     echo "{\"REQUIRED_MIN_SDK_VERSION\": \"$NEW_VERSION_NUMBER\"}" > packages/cli/sdk-compatibility.json

      # - name: Build packages
      #   run: yarn build

      # - name: Update yarn.lock files in test directories
      #   run: |
      #     cd testing/expo && yarn install --no-immutable
      #     cd ../react-native && yarn install --no-immutable

      # - name: Commit and push updated files
      #   uses: EndBug/add-and-commit@v7
      #   with:
      #     author_name: Sherlo Bot
      #     author_email: admin@sherlo.io
      #     message: Version updates and builds for ${{ github.event.inputs.NEW_VERSION_NUMBER }}
      #     push: true
      #     branch: ${{ github.ref_name }}

      - name: Debug - Show versions and config
        run: |
          echo "=== Node/npm/yarn versions ==="
          node --version
          npm --version
          yarn --version
          npx lerna --version
          echo ""
          echo "=== npm config ==="
          npm config list
          echo ""
          echo "=== .npmrc location ==="
          echo "NPM_CONFIG_USERCONFIG: $NPM_CONFIG_USERCONFIG"
          cat $NPM_CONFIG_USERCONFIG 2>/dev/null || echo "No .npmrc found at NPM_CONFIG_USERCONFIG"

      # Verify OIDC is available before attempting publish
      # This will fail early with a clear error if OIDC isn't configured
      - name: Verify OIDC availability
        run: |
          echo "=== Checking OIDC token availability ==="
          echo "ACTIONS_ID_TOKEN_REQUEST_URL: $ACTIONS_ID_TOKEN_REQUEST_URL"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN is set: $([ -n "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ] && echo 'yes' || echo 'no')"

          if [ -z "$ACTIONS_ID_TOKEN_REQUEST_URL" ]; then
            echo ""
            echo "❌ ERROR: OIDC is NOT available!"
            echo ""
            echo "Possible causes:"
            echo "  1. The 'id-token: write' permission might not be taking effect"
            echo "  2. Your organization might have disabled OIDC tokens"
            echo "  3. Check: Settings > Actions > General > Workflow permissions"
            echo ""
            echo "Workaround: Use a traditional NPM_TOKEN instead of trusted publishing"
            exit 1
          else
            echo "✅ OIDC is available"
          fi

      - name: Publish to npm
        env:
          NPM_CONFIG_PROVENANCE: true
        run: |
          # Clear the placeholder auth token that setup-node creates when using registry-url
          # Without this, npm tries to use the invalid placeholder token instead of OIDC
          # See: https://docs.npmjs.com/trusted-publishers#troubleshooting
          npm config delete //registry.npmjs.org/:_authToken || true

          echo "=== npm config after clearing token ==="
          npm config list

          npx lerna publish from-package --no-private --yes --dist-tag ${{ github.event.inputs.IS_ALPHA == 'true' && 'alpha' || 'latest' }} --loglevel verbose

      - name: Tag Commit
        if: ${{ github.event.inputs.IS_ALPHA != 'true' }}
        run: |
          git tag ${{ github.event.inputs.NEW_VERSION_NUMBER }}
          git push origin ${{ github.event.inputs.NEW_VERSION_NUMBER }}

      - name: Create Release
        if: ${{ github.event.inputs.IS_ALPHA != 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.NEW_VERSION_NUMBER }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: notify failure on Slack
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,action,eventName,ref,workflow,job,took
