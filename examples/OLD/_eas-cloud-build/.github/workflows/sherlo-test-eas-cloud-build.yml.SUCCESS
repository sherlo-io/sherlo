name: Sherlo Test - EAS Cloud Build

# ------------------------------------------------------------------------------
# WORKFLOW VISUALIZATION:
#
# [ ğŸ” Validate Config ]
#          â”‚
#          â–¼
# [ ğŸ§ª Run Sherlo ]  <-- Starts in "Wait for EAS" mode
#          â”‚
#          â–¼
# [ ğŸš€ Trigger EAS ] <-- Sends code + Sherlo metadata to Expo
#          â”‚
#          â–¼
# [ ğŸ Done ]        <-- Sherlo Server takes over the testing
# ------------------------------------------------------------------------------

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. CONFIGURATION CHECK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ” Validate Sherlo & EAS setup
        uses: ./.github/actions/validate-sherlo
        with:
          expo-token: ${{ secrets.EXPO_TOKEN }}
          sherlo-token: ${{ secrets.SHERLO_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. RUN SHERLO AND TRIGGER EAS BUILD
  # Both steps must run in the same job to share local metadata
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sherlo-cloud:
    name: EAS Cloud Build & Test
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          # cache: 'yarn'

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

    #   - name: ğŸ“¥ Install dependencies
    #     run: yarn install

      - name: ğŸ§ª Run Sherlo (Wait for EAS mode)
        run: |
          npx sherlo test:eas-cloud-build \
            --token ${{ secrets.SHERLO_TOKEN }} \
            --waitForEasBuild

      - name: ğŸš€ Trigger EAS Build
        run: |
          eas build \
            --non-interactive \
            --no-wait \
            --platform all \
            --profile preview-simulator