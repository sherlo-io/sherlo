name: Sherlo Test - EAS Update

# ------------------------------------------------------------------------------
# WORKFLOW VISUALIZATION:
#
#      [ ğŸ” Validate Config ]
#               â”‚
#               â–¼
#      [ ğŸ§¬ Check Native Code ] â”€â”€â”€â”€â”€â”€â” (Has anything native changed?)
#               â”‚                    â”‚
#       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”            â”‚
#       â–¼               â–¼            â”‚
#  [ ğŸ¤– Android ]  [ ğŸ iOS ] <â”€â”€â”€â”€â”€â”€â”¤ (Builds ONLY if code changed)
#       â”‚               â”‚            â”‚
#       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
#               â–¼                    â”‚
#      [ ğŸš€ Update & Test ] <â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (EAS Update + Sherlo)
# ------------------------------------------------------------------------------

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. VALIDATE: Check if secrets are missing before doing anything
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ” Check Secrets & Expo Setup
        uses: ./.github/actions/validate-sherlo
        with:
          expo-token: ${{ secrets.EXPO_TOKEN }}
          sherlo-token: ${{ secrets.SHERLO_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. FINGERPRINT: Detect if native code (Java/Swift/Config) has changed
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  check-native-changes:
    name: Check Native Code Changes
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      native_hash: ${{ steps.fingerprint.outputs.hash }}
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: ğŸ“¥ Install dependencies
        run: yarn install

      - name: ğŸ§¬ Calculate native fingerprint
        id: fingerprint
        run: |
          HASH=$(npx @expo/fingerprint . | jq -r '.hash')
          echo "hash=$HASH" >> $GITHUB_OUTPUT
        
      # HASH=$(npx @expo/fingerprint .)
      # HASH=$(npx @expo/fingerprint . --quiet)

      # - name: ğŸ§¬ Calculate Fingerprint
      #   id: fingerprint
      #   run: |
      #     HASH=$(npx @expo/fingerprint . | sha256sum | cut -d ' ' -f 1)
      #     echo "hash=$HASH" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. ANDROID BUILD: Get build from cache OR build it from scratch
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-android:
    name: Android Build (Smart)
    runs-on: ubuntu-latest
    needs: [check-native-changes]
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¥ Try to get build from Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: android.apk
          key: android-${{ needs.check-native-changes.outputs.native_hash }}

      - name: ğŸ”¨ Build APK (Only if native code changed)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          yarn install
          eas build \
            --non-interactive \
            --local \
            --platform android \
            --profile development-simulator \
            --output android.apk

      - name: ğŸ“¤ Upload for Sherlo
        uses: actions/upload-artifact@v6
        with:
          name: android-build
          path: android.apk

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. iOS BUILD: Get build from cache OR build it from scratch
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-ios:
    name: iOS Build (Smart)
    runs-on: macos-latest
    needs: [check-native-changes]
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¥ Try to restore build from cache
        id: cache
        uses: actions/cache@v4
        with:
          path: ios.tar.gz
          key: ios-${{ needs.check-native-changes.outputs.native_hash }}

      - name: ğŸ”¨ Build iOS App (Only if native code changed)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          yarn install
          eas build \
            --non-interactive \
            --local \
            --platform ios \
            --profile development-simulator \
            --output ios.tar.gz

      - name: ğŸ“¤ Upload for Sherlo
        uses: actions/upload-artifact@v6
        with:
          name: ios-build
          path: ios.tar.gz

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 5. TEST: Run EAS Update and trigger Sherlo
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  run-tests:
    name: EAS Update & Sherlo
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: ğŸ“¥ Install dependencies (needed for update)
        run: yarn install
        
      - name: ğŸ“¥ Download all builds
        uses: actions/download-artifact@v7
        with:
          merge-multiple: true

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸš€ Publish EAS Update
        run: eas update --non-interactive --auto --branch main

      - name: ğŸ§ª Run Sherlo Test
        run: |
          npx sherlo test:eas-update \
            --android android.apk \
            --ios ios.tar.gz \
            --branch main \
            --token ${{ secrets.SHERLO_TOKEN }}