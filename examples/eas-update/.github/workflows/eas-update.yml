name: Sherlo Test - EAS Update

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW:
#                         [ ğŸ§¬ Calculate Fingerprint ]
#                                      â”‚
#                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                      â–¼                               â–¼
#           [ ğŸ¤– Reuse / Build Android ]    [ ğŸ Reuse / Build iOS ]
#                      â”‚                               â”‚
#                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                      â–¼
#                             [ ğŸ§ª Update & Test ]
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Triggers on:
# - Push to main branch
# - Manual trigger from GitHub UI
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # SETUP VALIDATOR (optional, remove after successful run)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate:
    name: Validate Setup
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ” Check tokens and EAS configuration
        uses: ./.github/actions/validate-setup
        with:
          sherlo-token: ${{ secrets.SHERLO_TOKEN }}
          expo-token: ${{ secrets.EXPO_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #
  #                         â–¼ CORE SHERLO WORKFLOW â–¼
  #
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§¬ CALCULATE FINGERPRINT
  #
  # Calculates native code fingerprint for cache key
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fingerprint:
    name: Calculate Fingerprint
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      hash: ${{ steps.fingerprint.outputs.hash }}

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: ğŸ“¥ Install dependencies
        run: yarn install

      - name: ğŸ§¬ Calculate native fingerprint
        id: fingerprint
        run: |
          HASH=$(npx @expo/fingerprint . | jq -r '.hash')
          echo "hash=$HASH" >> $GITHUB_OUTPUT

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ¤– REUSE / BUILD ANDROID
  #
  # Reuses existing build from cache or rebuilds if native code changed
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  reuse-or-build-android:
    name: Reuse / Build Android
    runs-on: ubuntu-latest
    needs: [fingerprint]

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ’¾ Restore build from cache
        id: cache
        uses: actions/cache@v5
        with:
          path: android.apk
          key: android-${{ needs.fingerprint.outputs.hash }}

      - name: ğŸ“¥ Install dependencies (if not cached)
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn install

      # Uses 'development-simulator' profile from eas.json
      - name: ğŸ¤– Build Android (if not cached)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          eas build \
            --non-interactive \
            --local \
            --platform android \
            --profile development-simulator \
            --output android.apk

      - name: ğŸ“¤ Upload Android build
        uses: actions/upload-artifact@v6
        with:
          name: android-build
          path: android.apk

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ REUSE / BUILD iOS
  #
  # Reuses existing build from cache or rebuilds if native code changed
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  reuse-or-build-ios:
    name: Reuse / Build iOS
    runs-on: macos-latest
    needs: [fingerprint]

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ’¾ Restore build from cache
        id: cache
        uses: actions/cache@v5
        with:
          path: ios.tar.gz
          key: ios-${{ needs.fingerprint.outputs.hash }}

      - name: ğŸ“¥ Install dependencies (if not cached)
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn install

      # Uses 'development-simulator' profile from eas.json
      - name: ğŸ Build iOS (if not cached)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          eas build \
            --non-interactive \
            --local \
            --platform ios \
            --profile development-simulator \
            --output ios.tar.gz

      - name: ğŸ“¤ Upload iOS build
        uses: actions/upload-artifact@v6
        with:
          name: ios-build
          path: ios.tar.gz

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§ª UPDATE & TEST
  #
  # Publishes JavaScript changes via EAS Update and runs visual tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ota-update-and-test:
    name: Update & Test
    runs-on: ubuntu-latest
    needs: [reuse-or-build-android, reuse-or-build-ios]

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¥ Install dependencies
        run: yarn install

      - name: âš¡ Publish OTA Update
        run: eas update --non-interactive --auto --branch main

      - name: ğŸ“¥ Download Android and iOS builds
        uses: actions/download-artifact@v7
        with:
          merge-multiple: true

      # Uses 'test:eas-update' mode (standard / eas-update / eas-cloud-build)
      - name: ğŸ§ª Run Sherlo test
        run: |
          npx sherlo test:eas-update \
            --android android.apk \
            --ios ios.tar.gz \
            --branch main \
            --token ${{ secrets.SHERLO_TOKEN }}
