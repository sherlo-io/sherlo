name: Sherlo Test - EAS Update

# ------------------------------------------------------------------------------
# WORKFLOW VISUALIZATION:
#
# [ ğŸ” Validate ]
#          â”‚
#          â–¼
# [ ğŸ§¬ Check Fingerprint ] â”€â”€â”€â”
#          â”‚                  â”‚
#    (Cache Hit?) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€ (Cache Miss?)
#          â”‚                  â”‚           â”‚
#          â–¼                  â”‚           â–¼
# [ ğŸ“¥ Restore Builds ]       â”‚    [ ğŸ”¨ Build Native (EAS) ]
#          â”‚                  â”‚           â”‚
#          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                             â–¼
#                    [ ğŸš€ EAS Update ]
#                             â”‚
#                             â–¼
#                    [ ğŸ§ª Run Sherlo ]
# ------------------------------------------------------------------------------

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. PRE-FLIGHT CHECK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ” Validate Sherlo & EAS setup
        uses: ./.github/actions/validate-sherlo
        with:
          expo-token: ${{ secrets.EXPO_TOKEN }}
          sherlo-token: ${{ secrets.SHERLO_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. UPDATE & TEST (On macOS to allow local iOS builds)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-and-test:
    name: EAS Update & Sherlo
    runs-on: macos-latest # <--- FIX: Musi byÄ‡ macOS dla lokalnego iOS
    needs: validate
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¥ Install dependencies
        run: yarn install

      # Generujemy fingerprint kodu natywnego
      - name: ğŸ§¬ Check Native Fingerprint
        id: fingerprint
        run: |
          HASH=$(npx @expo/fingerprint . | shasum -a 256 | cut -d ' ' -f 1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      # PrÃ³bujemy przywrÃ³ciÄ‡ buildy z cache
      - name: ğŸ“¥ Restore Native Builds from Cache
        id: cache-builds
        uses: actions/cache@v4
        with:
          path: |
            android.apk
            ios.tar.gz
          key: ${{ runner.os }}-builds-${{ steps.fingerprint.outputs.hash }}

      # JeÅ›li kod natywny siÄ™ zmieniÅ‚ (brak cache) -> budujemy obie platformy
      - name: ğŸ”¨ Build Native Apps (Local)
        if: steps.cache-builds.outputs.cache-hit != 'true'
        run: |
          eas build --platform android --profile preview-simulator --non-interactive --local --output android.apk
          eas build --platform ios --profile preview-simulator --non-interactive --local --output ios.tar.gz

      # Publikujemy JS Update
      - name: ğŸš€ Publish EAS Update
        run: npx eas-cli update --auto --branch main --non-interactive

      # Odpalamy Sherlo
      - name: ğŸ§ª Run Sherlo Test
        run: |
          npx sherlo test:eas-update \
            --android android.apk \
            --ios ios.tar.gz \
            --branch main \
            --token ${{ secrets.SHERLO_TOKEN }}